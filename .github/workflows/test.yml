name: test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ubuntu:
    name: ubuntu-latest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
      - name: Install clang
        uses: ConorMacBride/install-package@v1
        with:
          apt: clang libc6-dev-i386
      - name: Install GOAT
        run: go install .
      - name: Run tests
        run: |
          goat tests/src/universal.c -o tests
          go test -C ./tests -v

  arm:
    name: ubuntu-24.04-arm
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
      - name: Install clang
        uses: ConorMacBride/install-package@v1
        with:
          apt: clang
      - name: Install GOAT
        run: go install .
      - name: Run tests
        run: |
          goat tests/src/universal.c -o tests
          go test -C ./tests -v

  macos:
    name: macos-latest
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: stable
      - name: Install clang and binutils
        run: brew install llvm binutils
      - name: Install GOAT
        run: go install .
      - name: Run tests
        run: |
          export PATH=/opt/homebrew/opt/llvm/bin:$PATH
          export PATH=/opt/homebrew/opt/binutils/bin:$PATH
          goat tests/src/universal.c -o tests
          go test -C ./tests -v

  windows:
    name: windows-latest
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
      - name: Install LLVM and MinGW-w64
        uses: ConorMacBride/install-package@v1
        with:
          choco: llvm mingw
      - name: Install GOAT
        run: go install .
      - name: Run tests
        run: |
          goat tests/src/universal.c -o tests
          go test -C ./tests -v

  cross-compile:
    name: cross-compile-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang binutils-aarch64-linux-gnu binutils-riscv64-linux-gnu
      - name: Install GOAT
        run: go install .
      - name: Cross-compile arm64 on x86_64
        run: |
          mkdir -p /tmp/cross-bin/arm64
          ln -sf /usr/bin/aarch64-linux-gnu-objdump /tmp/cross-bin/arm64/objdump
          PATH="/tmp/cross-bin/arm64:$PATH" goat tests/src/universal.c -o tests -t arm64 --target-os linux
          cd tests && GOARCH=arm64 GOOS=linux go build .
      - name: Cross-compile arm64 NEON on x86_64 (no target sysroot)
        run: |
          mkdir -p /tmp/cross-out
          ln -sf /usr/bin/aarch64-linux-gnu-objdump /tmp/cross-bin/arm64/objdump
          PATH="/tmp/cross-bin/arm64:$PATH" goat tests/src/neon.c -o /tmp/cross-out -t arm64 --target-os linux
          cd /tmp/cross-out && GOARCH=arm64 GOOS=linux go build .
      - name: Cross-compile arm64 NEON const pool on x86_64
        run: |
          PATH="/tmp/cross-bin/arm64:$PATH" goat tests/src/const_pool_neon.c -o /tmp/cross-out -t arm64 --target-os linux
          cd /tmp/cross-out && GOARCH=arm64 GOOS=linux go build .
      - name: Cross-compile riscv64 on x86_64
        run: |
          mkdir -p /tmp/cross-bin/riscv64
          ln -sf /usr/bin/riscv64-linux-gnu-objdump /tmp/cross-bin/riscv64/objdump
          PATH="/tmp/cross-bin/riscv64:$PATH" goat tests/src/universal.c -o tests -t riscv64 --target-os linux -march=rv64imafd
          cd tests && GOARCH=riscv64 GOOS=linux go build .

  riscv:
    name: ubuntu-24.04-riscv
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: uraimo/run-on-arch-action@v3
        with:
          arch: riscv64
          distro: ubuntu24.04
          githubToken: ${{ github.token }}
          dockerRunArgs: |
            --volume "${PWD}:/opt/goat"
          install: |
            apt-get update
            apt-get install -y clang golang
          run: |
            cd /opt/goat
            go run . tests/src/universal.c -o tests -march=rv64imafd
            go test -C ./tests -v
